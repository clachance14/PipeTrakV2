# Implementation Plan: Component Metadata Editing from Drawings View

**Branch**: `020-component-metadata-editing` | **Date**: 2025-10-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/020-component-metadata-editing/spec.md`

## Summary

Enable Admin and Manager users to edit component metadata (Area, System, Test Package) directly from the drawings table through a modal interface. The feature includes inline creation of new metadata entries, optimistic locking for concurrent edit detection, searchable virtualized dropdowns for large datasets (3000+ entities), and read-only access for non-admin users with milestone history display.

## Technical Context

**Language/Version**: TypeScript 5.6 (strict mode), React 18.3
**Primary Dependencies**: TanStack Query v5, TanStack Virtual v3, Radix UI primitives, Supabase JS Client v2.58, React Hook Form v7, Zod v4
**Storage**: Supabase PostgreSQL (remote only) with existing tables: components, milestone_events, areas, systems, test_packages
**Testing**: Vitest v3 with Testing Library, jsdom
**Target Platform**: Web (Chrome/Firefox/Safari, iOS Safari, Chrome Mobile)
**Project Type**: Single web application (React SPA)
**Performance Goals**: Modal open <200ms, save + table update <1s, search filtering instant with 3000 entities
**Constraints**: Optimistic updates required for perceived performance, virtualization mandatory for 1000+ dropdown items, keyboard navigation WCAG 2.1 AA compliant
**Scale/Scope**: Support 3000 metadata entities (1000 Areas, 1000 Systems, 1000 Test Packages) per project

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Principle I: Type Safety First ✅
- **Gate**: TypeScript strict mode with no unjustified type assertions
- **Status**: PASS - Feature uses strict TypeScript with Supabase-generated types, no `as` needed
- **Verification**: All database types imported from `src/types/database.types.ts`, Zod schemas for form validation

### Principle II: Component-Driven Development ✅
- **Gate**: Follow shadcn/ui patterns with Radix UI primitives
- **Status**: PASS - Modal uses Radix Dialog, combobox uses Radix Popover + Command pattern, reusable components in `src/components/`
- **Verification**: `ComponentMetadataModal.tsx` with edit/view variants, `SearchableCombobox.tsx` with virtualization

### Principle III: Testing Discipline ✅
- **Gate**: TDD workflow with tests before implementation
- **Status**: PASS - Tasks ordered with tests first per Red-Green-Refactor cycle
- **Verification**: Integration tests for all 4 user stories, unit tests for combobox virtualization, RLS policy tests

### Principle IV: Supabase Integration Patterns ✅
- **Gate**: RLS enabled, TanStack Query wrapping, no service role key in frontend
- **Status**: PASS - Existing RLS policies on components/areas/systems/test_packages, TanStack Query hooks for mutations
- **Verification**: Update existing `useUpdateComponent` hook, create `useCreateArea/System/TestPackage` hooks with optimistic updates

### Principle V: Specify Workflow Compliance ✅
- **Gate**: Constitution gates verified, tasks ordered with TDD sequence
- **Status**: PASS - This plan includes research phase, design artifacts, and TDD task ordering
- **Verification**: Tasks generated by `/tasks` command will include test-first sequence

### Security & Multi-tenancy ✅
- **Gate**: RLS policies filter by organization_id
- **Status**: PASS - Existing components table has RLS filtering by project → organization_id
- **Details**:
  - Components: `organization_id` derived via `project_id → projects.organization_id`
  - Areas/Systems/Test Packages: Direct `organization_id` column with existing RLS
  - Version field added to components table for optimistic locking (new migration required)

**GATE RESULT**: ✅ **PASS** - All constitution principles satisfied, proceed to Phase 0

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── components/
│   ├── ui/               # Shadcn/ui primitives (existing)
│   │   ├── dialog.tsx
│   │   ├── popover.tsx
│   │   └── command.tsx
│   ├── drawing-table/    # Existing drawing table components
│   │   ├── DrawingTable.tsx
│   │   ├── ComponentRow.tsx  # Modified: add onClick handler
│   │   └── ComponentRow.test.tsx
│   └── component-metadata/  # NEW: Feature components
│       ├── ComponentMetadataModal.tsx        # Main modal (edit + view modes)
│       ├── ComponentMetadataModal.test.tsx
│       ├── SearchableCombobox.tsx            # Virtualized combobox with search
│       ├── SearchableCombobox.test.tsx
│       ├── MetadataFormFields.tsx            # Area/System/TestPackage fields
│       ├── MetadataFormFields.test.tsx
│       ├── MilestoneHistoryView.tsx          # Read-only milestone events
│       └── MilestoneHistoryView.test.tsx
├── hooks/
│   ├── useComponentMetadata.ts        # Query hook for component + metadata
│   ├── useComponentMetadata.test.ts
│   ├── useUpdateComponent.ts          # Mutation hook (MODIFIED: add version check)
│   ├── useCreateMetadata.ts           # Mutation hooks for inline creation
│   ├── useCreateMetadata.test.ts
│   └── useMilestoneEvents.ts          # Query hook for milestone history
├── lib/
│   ├── supabase.ts                    # Existing client
│   └── validation.ts                  # Metadata name validation utils
└── types/
    ├── database.types.ts              # Supabase-generated (will regenerate)
    └── metadata.ts                    # NEW: Metadata form types

tests/
├── integration/
│   └── component-metadata/
│       ├── edit-metadata.test.ts           # User Story 1
│       ├── create-metadata.test.ts         # User Story 2
│       ├── clear-metadata.test.ts          # User Story 3
│       ├── view-only-access.test.ts        # User Story 4
│       └── concurrent-edits.test.ts        # Edge case: optimistic locking
└── unit/
    └── validation/
        └── metadata-validation.test.ts

supabase/migrations/
└── 00063_add_components_version_field.sql  # NEW: Add version column + trigger
```

**Structure Decision**: Single web application structure. Feature adds new component directory under `src/components/component-metadata/` following existing patterns (e.g., `drawing-table/`, `field-welds/`). Integration tests in `tests/integration/component-metadata/` mirror user stories from spec.

## Complexity Tracking

No constitutional violations. All gates pass without justification needed.

---

## Progress Tracking

- [ ] Phase 0: Research & Resolution
  - [ ] Research virtualization libraries for large dropdown lists
  - [ ] Research optimistic locking patterns with TanStack Query
  - [ ] Research Radix UI Command component for searchable combobox
  - [ ] Document findings in research.md
- [ ] Phase 1: Design & Contracts
  - [ ] Generate data-model.md with component version field migration
  - [ ] Generate API contracts for metadata CRUD operations
  - [ ] Generate quickstart.md for developer onboarding
  - [ ] Update CLAUDE.md with new technologies
- [ ] Phase 2: Task Breakdown (completed by `/tasks` command)

---

*Constitution Version: 1.0.2 | Plan Generated: 2025-10-29*
