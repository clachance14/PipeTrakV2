# Implementation Plan: Single-Organization User Model

**Branch**: `004-plan-the-single` | **Date**: 2025-10-07 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-plan-the-single/spec.md`

## Summary

Refactor the multi-organization user model to a single-organization model, where each user belongs to exactly one organization (their employer). This simplifies the data model, improves query performance, and aligns with the business reality that users are employees of a single company.

**Key Changes**:
- Remove `user_organizations` junction table
- Add `organization_id` and `role` columns directly to `users` table
- Update all RLS policies to use direct organization relationship
- Remove OrganizationSwitcher UI component
- Implement code-based role permission system (no `user_capabilities` table)
- Block invitation acceptance for users with existing organization

**Impact**: Development environment refactor with single user - migration is straightforward with validation checks.

## Technical Context

**Language/Version**: TypeScript 5 (strict mode)
**Primary Dependencies**: React 18, Supabase (PostgreSQL), TanStack Query v5, Vitest
**Storage**: PostgreSQL (Supabase) - schema modification required
**Testing**: Vitest + Testing Library, RLS integration tests
**Target Platform**: Web (React SPA)
**Project Type**: web (frontend src/, backend via Supabase)
**Performance Goals**: RLS queries <10ms (improvement from junction table removal)
**Constraints**: ≥70% test coverage, zero data loss, backward compatible auth flow
**Scale/Scope**: Single user in dev environment, validates for multi-user production

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Type Safety First
- [x] TypeScript strict mode enabled (verify tsconfig.json)
- [x] No `as` type assertions without justification in Complexity Tracking
- [x] Path aliases (`@/*`) used for imports
- [x] Database types will be generated from Supabase schema

**Justification**: No violations. Types auto-generated post-migration, all hooks type-safe.

### II. Component-Driven Development
- [x] New UI components follow shadcn/ui patterns (Radix + Tailwind)
- [x] Components maintain single responsibility
- [x] Server state via TanStack Query, client state via Zustand
- [x] No prop drilling beyond 2 levels

**Note**: Removing OrganizationSwitcher component, not adding new UI. Permission checks use `usePermissions()` hook.

### III. Testing Discipline
- [x] TDD approach confirmed (tests before implementation)
- [x] Integration tests cover spec acceptance scenarios
- [x] Test files colocated or in tests/ directory
- [x] Tests will use Vitest + Testing Library

**Tests Required**:
- RLS integration tests (multi-org validation, orphaned user validation)
- Permission system contract tests (all 7 roles × 6 permissions = 42 assertions)
- Hook API tests (useOrganization, useInvitations, usePermissions)
- Migration validation tests

### IV. Supabase Integration Patterns
- [x] RLS enabled on all new tables (users table modified, RLS updated)
- [x] Multi-tenant isolation via organization_id in policies (single-org simplifies this)
- [x] TanStack Query wraps all Supabase calls
- [x] Auth via AuthContext (no direct supabase.auth in components)
- [x] Realtime subscriptions cleaned up on unmount (if applicable)

**RLS Updates**: 4+ policies updated to reference `users.organization_id` directly (no JOIN to `user_organizations`)

### V. Specify Workflow Compliance
- [x] Feature has spec.md in specs/###-feature-name/
- [x] This plan.md follows template structure
- [x] Tasks.md will be generated by /tasks command
- [x] Implementation will follow /implement workflow

## Project Structure

### Documentation (this feature)
```
specs/004-plan-the-single/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file (/plan command output)
├── research.md          # Phase 0 output (complete)
├── data-model.md        # Phase 1 output (complete)
├── quickstart.md        # Phase 1 output (complete)
├── contracts/           # Phase 1 output (complete)
│   ├── README.md
│   ├── migration-schema.sql
│   ├── hooks-api.md
│   └── permissions-api.md
└── tasks.md             # Phase 2 output (/tasks command - NOT created yet)
```

### Source Code (repository root)
```
src/
├── lib/
│   ├── supabase.ts          # Existing
│   ├── permissions.ts       # NEW: Role-based permission mappings
│   └── auth.ts              # Existing (may need updates for new user schema)
├── hooks/
│   ├── useOrganization.ts   # MODIFIED: Remove multi-org functions
│   ├── useInvitations.ts    # MODIFIED: Add org validation
│   ├── useRegistration.ts   # MODIFIED: Ensure org assignment
│   └── usePermissions.ts    # NEW: Permission check hook
├── components/
│   ├── team/
│   │   ├── OrganizationSwitcher.tsx  # DELETED
│   │   ├── InvitationForm.tsx        # MODIFIED: Validation
│   │   └── TeamList.tsx               # Existing
│   └── Layout.tsx           # MODIFIED: Remove switcher reference
├── pages/
│   ├── Register.tsx         # MODIFIED: Atomic org assignment
│   ├── AcceptInvitation.tsx # MODIFIED: Block if user has org
│   └── TeamManagement.tsx   # Existing (minor updates)
└── types/
    └── database.types.ts    # REGENERATED: New users schema

supabase/migrations/
└── 00008_single_org_refactor.sql  # NEW: Migration script

tests/
├── contract/
│   ├── migration-schema.test.ts    # NEW: Validate migration SQL
│   ├── hooks-api.test.ts           # NEW: Hook contract tests
│   └── permissions-api.test.ts     # NEW: Permission matrix tests
├── integration/
│   └── rls/
│       └── single-org.test.ts      # NEW: RLS isolation tests
└── unit/
    └── permissions.test.ts         # NEW: Unit tests for permission logic
```

**Structure Decision**: Web application structure with React frontend and Supabase backend. Frontend code in `src/`, Supabase schema in `supabase/migrations/`, tests in `tests/` organized by type (contract, integration, unit).

## Phase 0: Outline & Research

**Status**: ✅ Complete

**Output**: `research.md` with all technical decisions documented

**Key Decisions Made**:
1. **Migration Approach**: Drop/recreate with validation (dev environment)
2. **Permission System**: Code-based TypeScript const (no database table)
3. **RLS Strategy**: Update policies to reference `users.organization_id`
4. **Component Removal**: Delete OrganizationSwitcher and references
5. **Test Strategy**: TDD with contract tests, RLS tests, permission tests
6. **Type Generation**: Re-generate from updated schema

**All NEEDS CLARIFICATION Resolved**: Yes, via /clarify workflow

## Phase 1: Design & Contracts

**Status**: ✅ Complete

**Artifacts Generated**:
1. ✅ **data-model.md**: Complete schema changes, relationships, RLS policies
2. ✅ **contracts/migration-schema.sql**: SQL migration contract with validation
3. ✅ **contracts/hooks-api.md**: Updated hook signatures and behavior
4. ✅ **contracts/permissions-api.md**: Permission matrix and API
5. ✅ **quickstart.md**: 11-step verification procedure
6. ✅ **CLAUDE.md**: Updated with single-org architecture notes

**Contract Tests Required** (will fail until implementation):
- `tests/contract/migration-schema.test.ts` - Validates migration SQL syntax
- `tests/contract/hooks-api.test.ts` - Validates hook return types
- `tests/contract/permissions-api.test.ts` - Validates 7 roles × 6 permissions

**Key Design Decisions**:
- Users table gains `organization_id UUID NOT NULL` and `role TEXT NOT NULL`
- `user_organizations` table dropped after data migration
- RLS policies simplified (no JOIN, better performance)
- Permission checks via code (`ROLE_PERMISSIONS` const object)
- Invitation validation prevents multi-org users

**Constitution Re-Check**: ✅ PASS - All principles followed, no violations

## Phase 2: Task Planning Approach

**Status**: Described (tasks.md generated by /tasks command)

**Task Generation Strategy**:

The `/tasks` command will generate tasks following TDD order:

### 1. Contract Tests (Must Fail First)
- Task: Write migration validation test (validates SQL syntax and constraints)
- Task: Write permission matrix contract test (42 assertions for 7 roles × 6 permissions)
- Task: Write hook API contract tests (useOrganization, useInvitations, usePermissions)
- Task: Write RLS integration tests (validate single-org isolation)
- **Expected**: All tests FAIL (no implementation yet)

### 2. Database Migration (Make Contract Tests Pass)
- Task: Create migration file `00008_single_org_refactor.sql`
- Task: Add pre-migration validation (check no multi-org, no orphaned users)
- Task: Add columns to users table (organization_id, role)
- Task: Migrate data from user_organizations to users
- Task: Drop user_organizations table
- Task: Update RLS policies (4+ policies)
- Task: Add indexes (idx_users_organization_id, idx_users_role)
- Task: Run migration on local Supabase
- Task: Verify migration validation tests pass

### 3. Permission System (Make Permission Tests Pass)
- Task: Create `src/lib/permissions.ts` with `ROLE_PERMISSIONS` const
- Task: Implement `hasPermission()` function
- Task: Create `src/hooks/usePermissions.ts` hook
- Task: Verify permission contract tests pass

### 4. Hook Updates (Make Hook API Tests Pass)
- Task: Update `useOrganization()` - remove multi-org functions
- Task: Add `useCurrentOrganization()` query
- Task: Update `useInvitations()` - add org validation
- Task: Update `useRegistration()` - ensure atomic org assignment
- Task: Verify hook API tests pass

### 5. Component Updates (Make Integration Tests Pass)
- Task: Delete `src/components/team/OrganizationSwitcher.tsx`
- Task: Update `src/components/Layout.tsx` - remove switcher reference
- Task: Update `src/pages/Register.tsx` - atomic org assignment
- Task: Update `src/pages/AcceptInvitation.tsx` - block if user has org
- Task: Verify registration integration test passes
- Task: Verify invitation integration test passes

### 6. Type Generation & Validation
- Task: Regenerate types: `npx supabase gen types typescript --linked > src/types/database.types.ts`
- Task: Fix TypeScript errors from type changes
- Task: Run `tsc -b` and verify zero errors

### 7. Test Coverage & Validation
- Task: Run quickstart verification (11 steps)
- Task: Run full test suite with coverage
- Task: Verify ≥70% coverage maintained
- Task: Update CLAUDE.md if needed

**Ordering Strategy**:
- TDD order: Tests → Implementation → Verification
- Dependency order: Database → Types → Hooks → Components
- Parallel opportunities marked [P]: Contract tests can be written in parallel

**Estimated Task Count**: 25-30 tasks

**IMPORTANT**: This phase is executed by the `/tasks` command, NOT by `/plan`

## Phase 3+: Future Implementation

*These phases are beyond the scope of the /plan command*

**Phase 3**: Task execution (/tasks command creates tasks.md)
**Phase 4**: Implementation (execute tasks.md following TDD)
**Phase 5**: Validation (run quickstart.md, verify all success criteria)

## Complexity Tracking

*No constitutional violations detected*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| N/A | N/A | N/A |

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research complete (/plan command)
- [x] Phase 1: Design complete (/plan command)
- [x] Phase 2: Task planning complete (/plan command - describe approach only)
- [ ] Phase 3: Tasks generated (/tasks command)
- [ ] Phase 4: Implementation complete
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS
- [x] Post-Design Constitution Check: PASS
- [x] All NEEDS CLARIFICATION resolved
- [x] Complexity deviations documented (none)

**Artifacts Generated**:
- [x] research.md
- [x] data-model.md
- [x] contracts/migration-schema.sql
- [x] contracts/hooks-api.md
- [x] contracts/permissions-api.md
- [x] quickstart.md
- [x] CLAUDE.md updated

**Next Command**: `/tasks` to generate tasks.md

---

*Based on Constitution v1.0.0 - See `.specify/memory/constitution.md`*
