
# Implementation Plan: User Registration & Team Onboarding

**Branch**: `002-user-registration-and` | **Date**: 2025-10-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/home/clachance14/projects/PipeTrak_V2/specs/002-user-registration-and/spec.md`

## Execution Flow (/plan command scope)
```
1. Load feature spec from Input path
   → If not found: ERROR "No feature spec at {path}"
2. Fill Technical Context (scan for NEEDS CLARIFICATION)
   → Detect Project Type from file system structure or context (web=frontend+backend, mobile=app+api)
   → Set Structure Decision based on project type
3. Fill the Constitution Check section based on the content of the constitution document.
4. Evaluate Constitution Check section below
   → If violations exist: Document in Complexity Tracking
   → If no justification possible: ERROR "Simplify approach first"
   → Update Progress Tracking: Initial Constitution Check
5. Execute Phase 0 → research.md
   → If NEEDS CLARIFICATION remain: ERROR "Resolve unknowns"
6. Execute Phase 1 → contracts, data-model.md, quickstart.md, agent-specific template file (e.g., `CLAUDE.md` for Claude Code, `.github/copilot-instructions.md` for GitHub Copilot, `GEMINI.md` for Gemini CLI, `QWEN.md` for Qwen Code, or `AGENTS.md` for all other agents).
7. Re-evaluate Constitution Check section
   → If new violations: Refactor design, return to Phase 1
   → Update Progress Tracking: Post-Design Constitution Check
8. Plan Phase 2 → Describe task generation approach (DO NOT create tasks.md)
9. STOP - Ready for /tasks command
```

**IMPORTANT**: The /plan command STOPS at step 7. Phases 2-4 are executed by other commands:
- Phase 2: /tasks command creates tasks.md
- Phase 3-4: Implementation execution (manual or via tools)

## Summary
Multi-tenant user registration and onboarding system enabling construction company managers to create organizations, invite team members with role-based access (7 roles: owner, admin, project manager, foreman, QC inspector, welder, viewer), and manage team permissions. Uses Supabase Auth for authentication with email/password, Row Level Security for multi-tenant isolation, and supports users belonging to multiple organizations with different roles.

## Technical Context
**Language/Version**: TypeScript 5.6.2 (strict mode)
**Primary Dependencies**: React 18.3, Supabase JS 2.58, TanStack Query 5.90, React Router 7.9, Zustand 5.0, Radix UI primitives
**Storage**: Supabase (PostgreSQL with Row Level Security)
**Testing**: Vitest 3.2.4 + Testing Library 16.3 with jsdom, coverage via v8
**Target Platform**: Web (Vite 6.0.5 SPA, deployed on Vercel)
**Project Type**: Single project (React SPA)
**Performance Goals**: Account creation <3s (NFR-001), invitation email delivery <1min (NFR-002), support ~50 users/org (NFR-003)
**Constraints**: Min 6 char passwords with email verification (NFR-004), cryptographic invitation tokens ≥32 bytes entropy (NFR-005)
**Scale/Scope**: Medium teams (~50 users/org), multi-org support per user, light pagination + basic search

## Constitution Check
*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Type Safety First
- [x] TypeScript strict mode enabled (tsconfig.app.json:8)
- [x] No `as` type assertions without justification in Complexity Tracking
- [x] Path aliases (`@/*`) configured for imports (tsconfig.app.json:24-26)
- [x] Database types will be generated from Supabase schema (supabase gen types)

### II. Component-Driven Development
- [x] New UI components follow shadcn/ui patterns (Radix UI + Tailwind CSS v4)
- [x] Components maintain single responsibility (registration form, invitation form, role selector as separate components)
- [x] Server state via TanStack Query, client state via Zustand (user registration flow, team management)
- [x] No prop drilling beyond 2 levels (AuthContext provides auth state, Zustand for active organization)

### III. Testing Discipline
- [x] TDD approach confirmed (tests before implementation per constitution)
- [x] Integration tests cover spec acceptance scenarios (7 scenarios from spec.md)
- [x] Test files colocated or in tests/ directory (src/components/*.test.tsx, tests/integration/)
- [x] Tests will use Vitest + Testing Library

### IV. Supabase Integration Patterns
- [x] RLS enabled on all new tables (invitations table requires RLS)
- [x] Multi-tenant isolation via organization_id in policies (existing pattern from Sprint 0)
- [x] TanStack Query wraps all Supabase calls (useQuery for fetches, useMutation for writes)
- [x] Auth via AuthContext (no direct supabase.auth in components)
- [x] Realtime subscriptions cleaned up on unmount (N/A for this feature - no realtime needed)

### V. Specify Workflow Compliance
- [x] Feature has spec.md in specs/002-user-registration-and/
- [x] This plan.md follows template structure
- [x] Tasks.md will be generated by /tasks command
- [x] Implementation will follow /implement workflow

## Project Structure

### Documentation (this feature)
```
specs/002-user-registration-and/
├── spec.md              # Feature specification (input)
├── plan.md              # This file (/plan command output)
├── research.md          # Phase 0 output (/plan command)
├── data-model.md        # Phase 1 output (/plan command)
├── quickstart.md        # Phase 1 output (/plan command)
├── contracts/           # Phase 1 output (/plan command)
│   ├── registration.schema.json
│   ├── invitations.schema.json
│   └── roles.schema.json
└── tasks.md             # Phase 2 output (/tasks command - NOT created by /plan)
```

### Source Code (repository root)
```
src/
├── components/
│   ├── auth/
│   │   ├── RegistrationForm.tsx
│   │   ├── RegistrationForm.test.tsx
│   │   └── OnboardingWizard.tsx
│   ├── team/
│   │   ├── InvitationForm.tsx
│   │   ├── InvitationForm.test.tsx
│   │   ├── RoleSelector.tsx
│   │   ├── TeamList.tsx
│   │   └── OrganizationSwitcher.tsx
│   └── ui/
│       ├── button.tsx (shadcn - if not exists)
│       ├── input.tsx (shadcn - if not exists)
│       └── select.tsx (shadcn - if not exists)
├── hooks/
│   ├── useRegistration.ts
│   ├── useInvitations.ts
│   └── useOrganization.ts
├── lib/
│   ├── auth.ts (registration helpers)
│   └── invitations.ts (token generation, validation)
├── pages/
│   ├── Register.tsx
│   ├── AcceptInvitation.tsx
│   └── TeamManagement.tsx
└── stores/
    └── organizationStore.ts (Zustand - active org context)

supabase/
└── migrations/
    └── 00002_invitations_table.sql

tests/
├── integration/
│   ├── registration.test.ts
│   ├── invitation-flow.test.ts
│   └── multi-org.test.ts
└── contract/
    ├── registration.contract.test.ts
    └── invitations.contract.test.ts
```

**Structure Decision**: Single project (React SPA). Feature adds auth components (`src/components/auth/`), team management UI (`src/components/team/`), supporting hooks for TanStack Query integration, and a new Supabase migration for the invitations table. Organization switching logic uses Zustand store to maintain active organization context across app.

## Phase 0: Outline & Research ✅ COMPLETE

**Research Areas Completed**:
1. ✅ Invitation token security (32-byte CSPRNG, SHA-256 hashing, NFR-005)
2. ✅ Invitation expiration period (7 days default per research findings)
3. ✅ Email service integration (Supabase Auth MVP → Resend production)
4. ✅ Multi-organization UX (Zustand store + localStorage persistence)
5. ✅ RBAC implementation (PostgreSQL ENUM + RLS policies)
6. ✅ Password security (6 char minimum + email verification per NFR-004)
7. ✅ Onboarding flows (conditional routing: owner wizard vs. invitee direct)
8. ✅ Last owner handling (transfer prompt → soft delete with 30-day recovery)

**Output**: research.md (8 sections, all technical decisions documented with rationale and alternatives)

## Phase 1: Design & Contracts ✅ COMPLETE

**Design Artifacts Generated**:

1. ✅ **data-model.md**: 4 entities with full schema definitions
   - Modified: `organizations` (added soft delete columns)
   - Modified: `user_organizations` (added role ENUM, soft delete)
   - New: `invitations` table (token-based workflow)
   - Auth: `auth.users` (Supabase-managed, metadata for full_name)
   - Includes: RLS policies, database triggers, TypeScript types, migration strategy

2. ✅ **API Contracts** (JSON Schema format in `/contracts/`):
   - `registration.schema.json`: User registration + org creation (FR-001 to FR-007)
   - `invitations.schema.json`: Team invitation workflow (FR-019 to FR-028)
   - `roles.schema.json`: Role management + org switching (FR-008 to FR-018, FR-031 to FR-033)
   - Total: 13 endpoints with request/response schemas, error cases, auth requirements

3. ✅ **quickstart.md**: 7 acceptance scenarios from spec.md
   - Scenario 1: First user signup (org creation)
   - Scenario 2: Owner invites team member
   - Scenario 3: New user accepts invitation
   - Scenario 4: Existing user accepts invitation (multi-org)
   - Scenario 5: Role-based dashboard access
   - Scenario 6: Owner changes user role
   - Scenario 7: Multi-org context switching
   - Plus: 5 edge cases, performance validation, rollback procedure

4. ✅ **CLAUDE.md updated**: Tech stack added via update-agent-context.sh
   - Language: TypeScript 5.6.2 (strict mode)
   - Frameworks: React 18.3, Supabase, TanStack Query, Zustand
   - Database: Supabase (PostgreSQL with RLS)

**Note**: Contract tests will be generated in `/tasks` phase (TDD order: tests before implementation per Constitution III)

## Phase 2: Task Planning Approach
*This section describes what the /tasks command will do - DO NOT execute during /plan*

**Task Generation Strategy**:
The `/tasks` command will generate tasks from Phase 1 design artifacts:

1. **Database Tasks** (from data-model.md):
   - Migration file creation (00002_invitations_table.sql)
   - ENUM type creation (user_role, invitation_status)
   - Table alterations (organizations, user_organizations)
   - New table creation (invitations)
   - RLS policy updates
   - Database triggers (prevent_last_owner_removal, cascade_org_soft_delete)
   - Type generation (npx supabase gen types)

2. **Contract Test Tasks** (from contracts/*.schema.json):
   - Registration API tests (2 endpoints)
   - Invitations API tests (6 endpoints)
   - Roles API tests (5 endpoints)
   - Total: 13 contract test files (all must fail initially per TDD)

3. **Integration Test Tasks** (from quickstart.md scenarios):
   - Scenario 1: First user signup test
   - Scenario 2: Invitation creation test
   - Scenario 3: New user acceptance test
   - Scenario 4: Existing user multi-org test
   - Scenario 5: Role-based access test
   - Scenario 6: Role change test
   - Scenario 7: Organization switching test
   - Edge cases: Expiration, revocation, last owner handling

4. **Component Tasks** (from project structure):
   - Auth components: RegistrationForm, OnboardingWizard
   - Team components: InvitationForm, RoleSelector, TeamList, OrganizationSwitcher
   - UI primitives: button, input, select (if not exists)

5. **Hook Tasks** (TanStack Query integration):
   - useRegistration (registration mutations)
   - useInvitations (CRUD operations)
   - useOrganization (org switching, member management)

6. **Helper Library Tasks**:
   - src/lib/auth.ts (registration helpers)
   - src/lib/invitations.ts (token generation/validation)
   - src/lib/permissions.ts (RBAC helpers per research.md)

7. **Store Tasks**:
   - organizationStore.ts (Zustand - active org context)

8. **Page Tasks**:
   - Register.tsx
   - AcceptInvitation.tsx
   - TeamManagement.tsx

**Ordering Strategy** (TDD + Dependency):
1. Database layer (migrations, types) [P]
2. Contract tests (failing) [P after DB]
3. Integration tests (failing) [P after DB]
4. Helper libraries (auth, invitations, permissions) + unit tests
5. Hooks (useRegistration, useInvitations, useOrganization) + tests
6. Zustand store + tests
7. UI components (shadcn if needed) [P]
8. Auth components + tests
9. Team components + tests
10. Pages + tests
11. Route integration (App.tsx updates)
12. E2E validation (run quickstart.md manually)

**Parallel Execution Markers**:
- [P] = Tasks can run in parallel (independent files)
- Database tasks must complete before tests (dependency)
- Tests before implementation (TDD requirement)
- UI primitives can run parallel with other component work

**Estimated Output**: 35-40 numbered, ordered tasks in tasks.md

**Complexity Notes**:
- No violations of Constitution (all checks passed)
- Straightforward React + Supabase architecture
- RLS complexity handled by research decisions (ENUM + policies)
- Token security complexity resolved (crypto.getRandomValues + SHA-256)

**IMPORTANT**: This phase is executed by the /tasks command, NOT by /plan

## Phase 3+: Future Implementation
*These phases are beyond the scope of the /plan command*

**Phase 3**: Task execution (/tasks command creates tasks.md)  
**Phase 4**: Implementation (execute tasks.md following constitutional principles)  
**Phase 5**: Validation (run tests, execute quickstart.md, performance validation)

## Complexity Tracking

**Status**: No complexity violations

All Constitution v1.0.0 principles satisfied:
- ✅ TypeScript strict mode (I)
- ✅ Shadcn/ui component patterns (II)
- ✅ TDD approach planned (III)
- ✅ Supabase RLS + multi-tenancy (IV)
- ✅ Specify workflow compliance (V)

No deviations requiring justification.

## Progress Tracking

**Phase Status**:
- [x] Phase 0: Research complete (/plan command) - research.md generated
- [x] Phase 1: Design complete (/plan command) - data-model.md, contracts/, quickstart.md, CLAUDE.md updated
- [x] Phase 2: Task planning complete (/plan command) - approach documented above
- [x] Phase 3: Tasks generated (/tasks command) - tasks.md with 60 ordered tasks
- [ ] Phase 4: Implementation complete - **NEXT STEP** (run /implement or execute manually)
- [ ] Phase 5: Validation passed

**Gate Status**:
- [x] Initial Constitution Check: PASS (all 5 principles satisfied)
- [x] Post-Design Constitution Check: PASS (re-verified after Phase 1)
- [x] All NEEDS CLARIFICATION resolved (no unknowns in Technical Context)
- [x] Complexity deviations documented (none - straightforward implementation)

---
*Based on Constitution v1.0.0 - See `.specify/memory/constitution.md`*
