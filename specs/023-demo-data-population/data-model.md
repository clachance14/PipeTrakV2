# Data Model: Demo Project Data Population

**Feature**: 023-demo-data-population
**Date**: 2025-11-02
**Status**: Complete

## Overview

This document defines the data model for demo project population. All entities use existing database tables (no schema changes required). The model focuses on the seed data structure and entity relationships.

## Entity Definitions

### 1. Areas (5 records per demo project)

**Purpose**: Organize components and drawings by physical location

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `name` (TEXT, unique per project)
- `description` (TEXT, nullable)
- `created_at` (TIMESTAMP

TZ, default now())

**Demo Values**:
```typescript
const DEMO_AREAS = [
  'Pipe Rack',
  'ISBL',
  'Containment Area',
  'Water Process',
  'Cooling Tower'
]
```

**Relationships**:
- One-to-many with components (via `area_id`)
- One-to-many with drawings (via area metadata)

**Unique Constraints**: `(project_id, name)`

---

### 2. Systems (5 records per demo project)

**Purpose**: Organize components and drawings by functional system

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `name` (TEXT, unique per project)
- `description` (TEXT, nullable)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Values**:
```typescript
const DEMO_SYSTEMS = [
  'Air',
  'Nitrogen',
  'Steam',
  'Process',
  'Condensate'
]
```

**Relationships**:
- One-to-many with components (via `system_id`)
- One-to-many with drawings (via system metadata)

**Unique Constraints**: `(project_id, name)`

---

### 3. Test Packages (10 records per demo project)

**Purpose**: Group components for testing/commissioning

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `name` (TEXT, unique per project)
- `description` (TEXT, nullable)
- `target_date` (DATE, nullable)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Values**:
```typescript
const DEMO_PACKAGES = [
  'TP-01', 'TP-02', 'TP-03', 'TP-04', 'TP-05',
  'TP-06', 'TP-07', 'TP-08', 'TP-09', 'TP-10'
]
```

**Relationships**:
- One-to-many with components (via `test_package_id`)

**Unique Constraints**: `(project_id, name)` (implied by index)

---

### 4. Welders (4 records per demo organization)

**Purpose**: Track individuals who perform welding work

**Fields**:
- `id` (UUID, PK, auto-generated)
- `organization_id` (UUID, FK → organizations)
- `stamp` (TEXT, unique per organization)
- `name` (TEXT)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Values**:
```typescript
const DEMO_WELDERS = [
  { stamp: 'JD-123', name: 'John Davis' },
  { stamp: 'SM-456', name: 'Sarah Miller' },
  { stamp: 'TR-789', name: 'Tom Rodriguez' },
  { stamp: 'KL-012', name: 'Kim Lee' }
]
```

**Relationships**:
- One-to-many with field_welds (via `welder_id`)

**Unique Constraints**: `(organization_id, stamp)`

---

### 5. Drawings (20 records per demo project)

**Purpose**: Construction isometric drawings grouping components

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `drawing_no_raw` (TEXT, original drawing number)
- `drawing_no_norm` (TEXT, normalized for searching, auto-generated by trigger)
- `title` (TEXT, nullable)
- `rev` (TEXT, nullable)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Distribution**:
- Realistic variety: 5-20 components per drawing
- Distributed across 5 areas and 5 systems
- Naming pattern: `ISO-{AREA_ABBREV}-{SEQUENCE}`

**Example Values**:
```typescript
const DEMO_DRAWINGS = [
  { drawing_number: 'ISO-PR-001', area: 'Pipe Rack', system: 'Steam' },
  { drawing_number: 'ISO-PR-002', area: 'Pipe Rack', system: 'Process' },
  { drawing_number: 'ISO-ISBL-001', area: 'ISBL', system: 'Air' },
  // ... 17 more
]
```

**Relationships**:
- One-to-many with components (via `drawing_id`)
- One-to-many with field_welds (via `drawing_id`)

**Unique Constraints**: `(project_id, drawing_no_norm)` where not retired

**Natural Key**: `drawing_no_norm` (used for lookups in seed data)

---

### 6. Components (200 records per demo project)

**Purpose**: Physical industrial items (spools, valves, supports, flanges, instruments)

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `component_type` (TEXT, one of: spool, valve, support, flange, instrument)
- `identity_key` (JSONB, type-specific identity)
- `drawing_id` (UUID, FK → drawings, nullable)
- `area_id` (UUID, FK → areas, nullable)
- `system_id` (UUID, FK → systems, nullable)
- `test_package_id` (UUID, FK → test_packages, nullable)
- `progress_template_id` (UUID, FK → progress_templates)
- `current_milestones` (JSONB, milestone states)
- `percent_complete` (NUMERIC, auto-calculated)
- `attributes` (JSONB, nullable)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Distribution**:
```typescript
const COMPONENT_DISTRIBUTION = {
  spool: 40,       // 20% - Receive, Erect, Connect, Punch
  support: 80,     // 40% - Receive, Install, Punch (2 per spool)
  valve: 50,       // 25% - Receive, Install, Punch
  flange: 20,      // 10% - Receive, Install, Punch
  instrument: 10   // 5% - Receive, Install, Punch
}
```

**Identity Key Patterns**:

**Spools**:
```typescript
{ spool_id: "SP-001" }
```

**Valves/Supports/Flanges/Instruments**:
```typescript
{
  drawing_norm: "ISO-PR-001",
  commodity_code: "VBALU-PFCBFLF00M-001",
  size: "2",
  seq: 1
}
```

**Milestone States**:
```typescript
// Example spool (6 milestones)
{
  receive: true,
  erect: true,
  connect: false,
  punch: false,
  test: false,
  restore: false
}

// Example valve (5 milestones)
{
  receive: true,
  install: true,
  punch: false,
  test: false,
  restore: false
}
```

**Milestone Progression Probabilities**:
- Receive: 90-95% (baseline milestone)
- Install/Erect: 60-70% (construction phase)
- Connect: 50% (spool-specific)
- Punch: 25-30% (quality control)
- Test: 0% (active construction, not ready)
- Restore: 0% (active construction, not ready)

**Relationships**:
- Many-to-one with drawings
- Many-to-one with areas
- Many-to-one with systems
- Many-to-one with test_packages
- Many-to-one with progress_templates

**Unique Constraints**: `(project_id, component_type, identity_key)` where not retired

**Natural Key**: Extracted tag from identity_key (e.g., `spool_id` for spools, combination of fields for others)

---

### 7. Field Welds (~120 records per demo project)

**Purpose**: Track welding work on pipe spools

**Fields**:
- `id` (UUID, PK, auto-generated)
- `project_id` (UUID, FK → projects)
- `drawing_id` (UUID, FK → drawings)
- `weld_number` (TEXT, unique per project)
- `weld_type` (TEXT, 'butt' or 'socket')
- `material` (TEXT, 'CS' for carbon steel)
- `welder_id` (UUID, FK → welders, nullable)
- `date_welded` (DATE, nullable)
- `current_milestones` (JSONB, milestone states)
- `created_at` (TIMESTAMPTZ, default now())

**Demo Distribution**:
- 3 welds per spool (40 spools × 3 = 120 welds)
- Mix of butt and socket welds
- All carbon steel material
- 65% have "Weld Made" complete (assigned to welder)
- 35% pending (no welder assigned yet)

**Example Values**:
```typescript
const DEMO_WELDS = [
  { weld_number: 'W-001', drawing: 'ISO-PR-001', type: 'butt', material: 'CS' },
  { weld_number: 'W-002', drawing: 'ISO-PR-001', type: 'socket', material: 'CS' },
  // ... 118 more
]
```

**Milestone States**:
```typescript
// Weld with welder assigned (65% of welds)
{
  fit_up: true,
  weld_made: true,   // Triggers welder assignment
  punch: false,
  test: false,
  restore: false
}

// Weld pending (35% of welds)
{
  fit_up: true,
  weld_made: false,  // No welder assigned
  punch: false,
  test: false,
  restore: false
}
```

**Welder Assignment Logic**:
- Welders assigned ONLY when "Weld Made" milestone is true
- Distribution: ~65% of welds (78 out of 120)
- Evenly distributed across 4 welders (~19-20 welds each)
- Date welded: Random date within past 30 days

**Relationships**:
- Many-to-one with drawings (welds linked to drawings, NOT components)
- Many-to-one with welders (nullable)

**Unique Constraints**: `(project_id, weld_number)` (implied)

**Natural Key**: `weld_number` (used for lookups in seed data)

---

## Seed Data Structure

**TypeScript Interface**:

```typescript
export interface DemoSeedData {
  // Phase 1: Skeleton (SQL function creates these)
  skeleton: {
    areas: string[];       // 5 areas
    systems: string[];     // 5 systems
    packages: string[];    // 10 packages
    welders: {
      stamp: string;
      name: string;
    }[];                   // 4 welders
  };

  // Phase 2: Bulk data (Edge Function creates these)
  drawings: {
    drawing_number: string;
    area: string;          // FK reference via natural key
    system: string;        // FK reference via natural key
  }[];                     // 20 drawings

  components: {
    tag: string;           // Natural key for lookups
    type: ComponentType;
    identity: IdentityKey; // Type-specific JSONB
    drawing: string;       // FK reference via natural key
    area: string;          // FK reference via natural key
    system: string;        // FK reference via natural key
    package: string;       // FK reference via natural key
  }[];                     // 200 components

  welds: {
    weld_number: string;   // Natural key for lookups
    drawing: string;       // FK reference via natural key (NOT component)
    type: 'butt' | 'socket';
    material: 'CS';
  }[];                     // ~120 welds

  milestones: {
    component_tag: string; // FK reference via natural key
    receive?: boolean;
    install?: boolean;
    erect?: boolean;
    connect?: boolean;
    punch?: boolean;
  }[];                     // 200 component milestone states

  weld_milestones: {
    weld_number: string;   // FK reference via natural key
    fit_up?: boolean;
    weld_made?: boolean;
    punch?: boolean;
  }[];                     // ~120 weld milestone states

  weld_assignments: {
    weld_number: string;   // FK reference via natural key
    welder_stamp: string;  // FK reference via natural key
    date_welded: string;   // ISO 8601 date string
  }[];                     // ~78 assignments (65% of welds)
}
```

---

## Entity Relationships

```
organizations
  ↓ 1:N
welders (4 per org)
  ↓ 1:N (nullable)
field_welds (~120 per project)
  ↑ N:1
drawings (20 per project)
  ↑ N:1
components (200 per project)
  ↓ N:1
areas (5 per project)
systems (5 per project)
test_packages (10 per project)
```

**Key Relationships**:
1. Welders belong to organization (not project) - shared across projects
2. Field welds link to drawings (NOT to component records) - critical distinction
3. Components link to drawings, areas, systems, packages
4. All entities (except welders) isolated by project_id via RLS

---

## Natural Key Mappings

**For Foreign Key Resolution During Insertion**:

```typescript
// Natural keys used in seed data
type NaturalKeys = {
  area: string;              // area name → area_id
  system: string;            // system name → system_id
  package: string;           // package name → test_package_id
  drawing: string;           // drawing_no_norm → drawing_id
  welder: string;            // welder stamp → welder_id
  component: string;         // extracted tag from identity_key → component_id
  weld: string;              // weld_number → weld_id
}

// Insertion order (dependency-driven)
1. Areas → Map<area.name, area.id>
2. Systems → Map<system.name, system.id>
3. Packages → Map<package.name, package.id>
4. Welders → Map<welder.stamp, welder.id>
5. Drawings → Map<drawing.drawing_no_norm, drawing.id>
6. Components → Map<component.tag, component.id>
7. Field Welds → Map<weld.weld_number, weld.id>
8. Update milestones (use component/weld maps)
9. Update welder assignments (use weld/welder maps)
```

---

## Validation Rules

**Enforced by Database**:
- Identity key structure must match component type (CHECK constraint)
- Percent complete range 0.00-100.00 (CHECK constraint)
- Attributes max 10KB JSON (CHECK constraint)
- Unique constraints on natural keys prevent duplicates

**Enforced by Seed Data**:
- Component distribution sums to 200
- 2 supports per spool (80 supports for 40 spools)
- All field welds are butt or socket, carbon steel
- Welder assignments only for welds with "Weld Made" true
- Milestone dependencies respected (can't install without receive)
- 0% test/restore (active construction state)

**Enforced by Insertion Logic**:
- Idempotency checks before insertion (WHERE NOT EXISTS or ON CONFLICT)
- Foreign key resolution via natural key lookups
- Database-generated UUIDs (no manual ID assignment)

---

## Summary

**Total Records Per Demo Project**:
- 5 areas
- 5 systems
- 10 test packages
- 4 welders (shared across projects in organization)
- 20 drawings
- 200 components (40 spools, 80 supports, 50 valves, 20 flanges, 10 instruments)
- ~120 field welds (3 per spool)
- ~78 welder assignments (65% of welds)

**No Schema Changes Required**: All entities use existing tables with current structure

**Natural Key Strategy**: Enables declarative seed data with type-safe foreign key resolution

**Next Steps**: Generate contracts/ directory with TypeScript interfaces and SQL function signature
