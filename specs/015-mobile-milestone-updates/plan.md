# Implementation Plan: Mobile Milestone Updates

**Branch**: `015-mobile-milestone-updates` | **Date**: 2025-10-24 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/home/clachance14/projects/PipeTrak_V2/specs/015-mobile-milestone-updates/spec.md`

**Note**: This plan was generated by the `/plan` command following the Specify workflow.

## Summary

Enable foremen to update component milestones from mobile devices (phones and tablets with viewports ≤1024px) with offline queue support. When offline, milestone updates are queued in localStorage (max 50 updates) and automatically sync when connection returns using server-wins conflict resolution. The implementation adapts the existing desktop drawing table UI (Feature 010) with responsive design: touch-friendly controls (44px targets), full-screen modals for slider inputs, and vertically stacked filters. Performance targets include <3s page load on 4G, <50ms optimistic UI updates, and exponential backoff retry (0s, 3s, 9s) for failed syncs.

## Technical Context

**Language/Version**: TypeScript 5.x (strict mode), React 18
**Primary Dependencies**: React 18, TanStack Query v5, Radix UI primitives, Tailwind CSS v4, Vite
**Storage**: Supabase PostgreSQL (existing schema, no new tables), localStorage (offline queue)
**Testing**: Vitest + Testing Library, jsdom environment, contract + integration tests
**Target Platform**: Modern mobile browsers (latest 2 versions), responsive web (not native apps)
**Project Type**: Web application (frontend-only, adapts existing React SPA)
**Performance Goals**: <3s page load (4G, 100 drawings), <50ms optimistic UI, <1s search results
**Constraints**: Offline-capable (localStorage queue, max 50 updates), touch-friendly (44px targets), viewport-driven responsive (≤1024px mobile UI)
**Scale/Scope**: Adapts 1 existing page (DrawingComponentTablePage), adds 3-5 new hooks (offline sync, mobile detection), 8-12 responsive UI components, ~15-20 integration tests

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Constitution Version**: 1.0.2 (ratified 2025-10-04, last amended 2025-10-23)

### Principle I: Type Safety First ✅
- **Status**: PASS
- **Check**: TypeScript strict mode, no new database types needed (reuses existing schema)
- **Evidence**: Feature adapts existing components, no `as` type assertions required

### Principle II: Component-Driven Development ✅
- **Status**: PASS
- **Check**: Responsive UI components follow shadcn/ui patterns with Radix primitives
- **Evidence**: Full-screen modals use Radix Dialog, touch controls use existing Button/Checkbox primitives

### Principle III: Testing Discipline ✅
- **Status**: PASS
- **Check**: TDD workflow with tests before implementation
- **Evidence**: Spec includes 4 user stories with acceptance scenarios, plan will generate contract tests first

### Principle IV: Supabase Integration Patterns ✅
- **Status**: PASS
- **Check**: No new tables (frontend-only), TanStack Query wraps existing mutation hooks, localStorage for offline queue only
- **Evidence**: Reuses existing `useUpdateMilestone()` hook, no RLS changes needed

### Principle V: Specify Workflow Compliance ✅
- **Status**: PASS
- **Check**: Full workflow used (`/specify` → `/clarify` → `/plan` → `/tasks` → `/implement`)
- **Evidence**: Spec created 2025-10-23, clarified 2025-10-24 (5 questions), planning in progress

### Summary
**All gates PASS** - No constitutional violations. Feature is frontend-only adaptation of existing functionality with responsive design and offline queue. No complexity justification needed.

## Project Structure

### Documentation (this feature)

```text
specs/015-mobile-milestone-updates/
├── spec.md              # Feature specification (complete with clarifications)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0: Technical research & feasibility
├── data-model.md        # Phase 1: Data structures & storage patterns
├── quickstart.md        # Phase 1: Developer onboarding guide
├── contracts/           # Phase 1: Contract test specifications
│   ├── offline-queue.contract.md
│   ├── responsive-ui.contract.md
│   └── sync-behavior.contract.md
└── tasks.md             # Phase 2: Task breakdown (generated by /tasks)
```

### Source Code (repository root)

```text
src/
├── components/
│   ├── drawing-table/               # Existing (Feature 010)
│   │   ├── DrawingTable.tsx         # Adapt for mobile
│   │   ├── DrawingRow.tsx           # Adapt for mobile
│   │   ├── ComponentRow.tsx         # Adapt for mobile
│   │   └── MobilePartialMilestoneEditor.tsx  # NEW (full-screen modal)
│   └── ui/                          # shadcn/ui components
│       ├── dialog.tsx               # Radix Dialog (existing)
│       └── slider.tsx               # Radix Slider (existing)
├── hooks/
│   ├── useUpdateMilestone.ts        # Existing (reuse)
│   ├── useOfflineQueue.ts           # NEW (localStorage queue management)
│   ├── useNetworkStatus.ts          # NEW (online/offline detection)
│   ├── useSyncQueue.ts              # NEW (sync logic with retry)
│   └── useMobileDetection.ts        # NEW (viewport-based mobile check)
├── lib/
│   ├── offline-queue.ts             # NEW (queue data structure, max 50)
│   ├── sync-manager.ts              # NEW (exponential backoff, server-wins)
│   └── responsive-utils.ts          # NEW (viewport helpers, touch detection)
└── pages/
    └── DrawingComponentTablePage.tsx  # Adapt with responsive wrappers

tests/
├── contract/
│   ├── offline-queue.contract.test.ts       # NEW (localStorage, max 50)
│   ├── responsive-ui.contract.test.ts       # NEW (viewport breakpoints)
│   └── sync-behavior.contract.test.ts       # NEW (retry, server-wins)
└── integration/
    ├── mobile-milestone-update.test.tsx     # NEW (User Story 1)
    ├── mobile-search-filter.test.tsx        # NEW (User Story 2)
    ├── offline-sync.test.tsx                # NEW (User Story 3)
    └── mobile-progress-view.test.tsx        # NEW (User Story 4)
```

**Structure Decision**: Web application (React SPA frontend only). This feature adapts existing components from Feature 010 (Drawing-Centered Component Progress Table) with responsive design patterns. No backend changes required - reuses existing Supabase milestone update RPC. New code focuses on: (1) offline queue management in localStorage, (2) responsive UI components for mobile viewports, (3) sync orchestration with exponential backoff.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**No violations** - Complexity Tracking table not needed. All constitutional gates pass.

---

## Progress Tracking

### Phase 0: Research ✅ COMPLETE
- ✅ Analyzed existing codebase (Feature 010 dependencies)
- ✅ Validated responsive design approach (Tailwind CSS v4 breakpoints)
- ✅ Researched offline queue design (localStorage API, 50-entry limit)
- ✅ Validated network detection API (navigator.onLine)
- ✅ Designed sync strategy (exponential backoff, server-wins)
- ✅ Confirmed no new dependencies needed
- ✅ Identified risks and mitigations
- **Artifact**: [research.md](./research.md)

### Phase 1: Design ✅ COMPLETE
- ✅ Defined client-side data structures (QueuedUpdate, OfflineQueue, SyncResult)
- ✅ Documented storage operations (enqueue, dequeue, retry increment)
- ✅ Specified error handling (queue full, quota exceeded, sync errors)
- ✅ Created contract test specifications:
  - ✅ [offline-queue.contract.md](./contracts/offline-queue.contract.md) - 15 tests (C001-C015)
  - ✅ [responsive-ui.contract.md](./contracts/responsive-ui.contract.md) - 20 tests (C016-C035)
  - ✅ [sync-behavior.contract.md](./contracts/sync-behavior.contract.md) - 25 tests (C036-C060)
- ✅ Wrote developer quickstart guide
- **Artifacts**: [data-model.md](./data-model.md), [contracts/](./contracts/), [quickstart.md](./quickstart.md)

### Phase 2: Task Breakdown ⏳ PENDING
- ⏳ Generate tasks.md with TDD-ordered implementation steps
- ⏳ Break down into bite-sized tasks (<4 hours each)
- ⏳ Order tasks: tests first, then implementation, then integration
- **Command**: `/tasks` (run after plan approval)

### Phase 3: Implementation ⏳ PENDING
- ⏳ Execute tasks via `/implement` command
- ⏳ Follow TDD workflow (Red → Green → Refactor)
- ⏳ Per-task commits with meaningful messages
- **Command**: `/implement` (run after tasks.md generated)

---

## Summary

**Feature**: Mobile Milestone Updates
**Branch**: `015-mobile-milestone-updates`
**Status**: Planning Complete, Ready for Task Breakdown

**Artifacts Generated**:
1. ✅ `spec.md` - Feature specification with 5 clarifications (2025-10-24)
2. ✅ `plan.md` - This implementation plan
3. ✅ `research.md` - Technical research and feasibility analysis
4. ✅ `data-model.md` - Client-side data structures and storage patterns
5. ✅ `contracts/offline-queue.contract.md` - 15 contract tests for queue operations
6. ✅ `contracts/responsive-ui.contract.md` - 20 contract tests for responsive behavior
7. ✅ `contracts/sync-behavior.contract.md` - 25 contract tests for sync orchestration
8. ✅ `quickstart.md` - Developer onboarding guide

**Next Steps**:
1. Review this plan
2. Run `/tasks` to generate task breakdown
3. Run `/implement` to execute TDD implementation

**Constitutional Compliance**: ✅ All gates pass (v1.0.2)

---

**Plan Generated**: 2025-10-24
**Constitution Version**: 1.0.2
**Estimated Implementation Time**: 3-5 days (based on 60 contract tests + 4 integration test suites + responsive UI adaptation)
